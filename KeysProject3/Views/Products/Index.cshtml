@{
    ViewBag.Title = "Products";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Products</h2>

@Scripts.Render("~/bundles/Library")
@Html.Partial("_Modal")

<table data-bind="ProductModel" class="table table-light table-hover" id="ProductsTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>Price</th>
            <th>Action(Edit)</th>
            <th>Action(Delete)</th>
        </tr>
    </thead>
    <tbody id="BodyTag" data-bind="foreach: Products">
        <tr>
            <td style="display:none" id="IdTag" data-bind="text: id"></td>
            <td id="NameTag" data-bind="text: name"></td>
            <td id="PriceTag" data-bind="text: price"></td>
            <td>
                <button class="btn btn-warning" data-target="#editProductModal" data-toggle="modal" type="button">
                    Edit
                </button>
            </td>
            <td>
                <button class="btn btn-danger" data-target="#deleteProductModal" data-toggle="modal" type="button">
                    Delete
                </button>
            </td>
        </tr>
    </tbody>
</table>

@section scripts
{
    <script>
        //Load table data
        $(function () {
            //Customise default validation configuration
            ko.validation.init({
                messagesOnModified: true, //Validation activated by triggers
                parseInputAttributes: true //Validation by HTML5 validation attributes
            });

            //Model
            function Product(data) {
                //Two way binding for customer elements
                this.id = ko.observable(data.id);
                this.name = ko.observable(data.name).extend({ required: "Please enter a name for the product." });
                this.price = ko.observable(data.price).extend({ required: "Please enter a price for the product." });
            }

            //Viewmodel
            var ProductModel = {
                    id: ko.observable(),
                    name: ko.observable().extend({ required: { message: "Please enter a name for the product." } }),
                    price: ko.observable().extend({ required: { message: "Please enter a price for the product." } }),
                    product : ko.observable(),
                    products : ko.observableArray(),

                    //Load Product data to table
                loadProducts: function () {
                    ProductModel.products.removeAll();
                    $.getJSON("/api/products", function (data) {
                        $.each(data, function (key, value) {//jQuery loop
                            ProductModel.products.push(new Product(value));
                        });
                    });
                },

                //Create Product
                createProduct : function () {
                    var created = ko.toJSON(this);
                    $.ajax({
                        url: 'api/products',
                        cache: false,
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: created,
                        success: function (data) {
                            location.reload(true);
                        },
                        error: function (xhr) {
                            alert(xhr.responseText);
                        }
                    });
                },

                //Delete Product
                deleteProduct: ko.observable(),
                deleteBtn: function (customer) {
                    ProductModel.deleteProduct(product);
                },
                deleteProd : function () {
                    var id = ko.toJS(ProductModel.deleteProduct()).id;
                    $.ajax({
                        url: 'api/products' + id,
                        cache: false,
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: id,
                        success: function (data) {
                            location.reload(true);
                        },
                        error: function (xhr) {
                            alert(xhr.responseText);
                        }
                    });
                },

                //Update Product
                productBtn: function (customer) {
                    ProductModel.updateProduct(product);
                },
                changeProduct: function () {
                    var updatedProduct = ko.toJS(ProductModel.updateProduct);
                    $.ajax({
                        url: 'api/customers' + updatedProduct.id,
                        cache: false,
                        type: 'PUT',
                        contentType: 'application/json; charset=utf-8',
                        data: ko.toJSON(Product),
                        success: function () {
                            location.reload(true);
                        },
                        error: function (xhr) {
                            alert(xhr.responseText);
                        }
                    });
                },

            }
            //Validate all properties of ProductModel and its 'child' properties
            ProductModel.errors = ko.validation.group(ProductModel, { deep: true });
            ko.applyBindings(ProductModel);
            ProductModel.loadProducts();
        });



    </script>}